<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Role Requests Management - NASCON Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/homepage.html">NASCON</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/homepage.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/event_management.html">Events</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            Management
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/accommodation_management.html">Accommodation</a></li>
                            <li><a class="dropdown-item" href="/admin/rooms.html">Rooms</a></li>
                            <li><a class="dropdown-item" href="/checkin_management.html">Check-ins</a></li>
                            <li><a class="dropdown-item" href="/admin/judge_assignment.html">Judge Assignment</a></li>
                            <li><a class="dropdown-item" href="/admin/evaluation.html">Evaluations</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" role="button" data-bs-toggle="dropdown">
                            Admin
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/admin/user_management.html">User Management</a></li>
                            <li><a class="dropdown-item active" href="/admin/role_requests.html">Role Requests</a></li>
                            <li><a class="dropdown-item" href="/sponsor_management.html">Sponsors</a></li>
                            <li><a class="dropdown-item" href="/admin/sponsorship_packages.html">Sponsorship Packages</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/user_profile.html">Profile</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutButton">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Role Request Management</h2>
        <p>Review and process user role change requests.</p>

        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Pending Role Requests</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Request ID</th>
                                <th>User</th>
                                <th>Email</th>
                                <th>Current Role</th>
                                <th>Requested Role</th>
                                <th>Date</th>
                                <th>Details</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pendingRequestsTable">
                            <!-- Pending requests will be loaded here -->
                            <tr>
                                <td colspan="9" class="text-center">Loading requests...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">Processed Role Requests</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Request ID</th>
                                <th>User</th>
                                <th>Email</th>
                                <th>Requested Role</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Processed Date</th>
                            </tr>
                        </thead>
                        <tbody id="processedRequestsTable">
                            <!-- Processed requests will be loaded here -->
                            <tr>
                                <td colspan="7" class="text-center">Loading requests...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Details Modal -->
    <div class="modal fade" id="requestDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">Request Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>User Information</h6>
                    <p><strong>Name:</strong> <span id="modalUserName"></span></p>
                    <p><strong>Email:</strong> <span id="modalEmail"></span></p>
                    <p><strong>Current Role:</strong> <span id="modalCurrentRole"></span></p>
                    <p><strong>Requested Role:</strong> <span id="modalRequestedRole"></span></p>
                    <p><strong>Request Date:</strong> <span id="modalRequestDate"></span></p>
                    
                    <h6>Request Details</h6>
                    <div class="card">
                        <div class="card-body" id="modalDetails">
                            <!-- Request details will be displayed here -->
                        </div>
                    </div>
                    
                    <div id="modalActions" class="mt-3">
                        <button id="approveBtn" class="btn btn-success">Approve Request</button>
                        <button id="rejectBtn" class="btn btn-danger">Reject Request</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentRequests = [];
        let selectedRequestId = null;
        
        // Logout functionality
        document.getElementById('logoutButton').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                const response = await fetch('/logout', { method: 'POST' });
                if (response.ok) {
                    window.location.href = '/login.html';
                } else {
                    alert('Logout failed');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Logout failed');
            }
        });
        
        // Load role requests
        async function loadRoleRequests() {
            try {
                const response = await fetch('/api/admin/role-requests');
                if (!response.ok) {
                    throw new Error('Failed to fetch role requests');
                }
                
                const data = await response.json();
                if (!data.data || !Array.isArray(data.data)) {
                    throw new Error('Invalid response format');
                }
                
                currentRequests = data.data;
                
                // Split requests into pending and processed
                const pendingRequests = currentRequests.filter(req => req.Status === 'Pending');
                const processedRequests = currentRequests.filter(req => req.Status !== 'Pending');
                
                // Update tables
                updatePendingRequestsTable(pendingRequests);
                updateProcessedRequestsTable(processedRequests);
                
            } catch (error) {
                console.error('Error loading role requests:', error);
                document.getElementById('pendingRequestsTable').innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-danger">
                            <i class="bi bi-exclamation-triangle"></i> Error loading requests: ${error.message}
                        </td>
                    </tr>
                `;
                document.getElementById('processedRequestsTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger">
                            <i class="bi bi-exclamation-triangle"></i> Error loading requests: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        // Update pending requests table
        function updatePendingRequestsTable(requests) {
            const tableBody = document.getElementById('pendingRequestsTable');
            
            if (requests.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center">No pending role requests found</td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = requests.map(request => `
                <tr>
                    <td>${request.RequestID}</td>
                    <td>${request.UserName}</td>
                    <td>${request.Email}</td>
                    <td>${getCurrentRole(request)}</td>
                    <td>${request.RequestedRole}</td>
                    <td>${formatDate(request.RequestTimestamp)}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="showRequestDetails(${request.RequestID})">
                            <i class="bi bi-eye"></i> View
                        </button>
                    </td>
                    <td><span class="badge bg-warning">Pending</span></td>
                    <td>
                        <button class="btn btn-sm btn-success me-1" onclick="approveRequest(${request.RequestID})">
                            <i class="bi bi-check-circle"></i> Approve
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="rejectRequest(${request.RequestID})">
                            <i class="bi bi-x-circle"></i> Reject
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Update processed requests table
        function updateProcessedRequestsTable(requests) {
            const tableBody = document.getElementById('processedRequestsTable');
            
            if (requests.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">No processed role requests found</td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = requests.map(request => `
                <tr>
                    <td>${request.RequestID}</td>
                    <td>${request.UserName}</td>
                    <td>${request.Email}</td>
                    <td>${request.RequestedRole}</td>
                    <td>${formatDate(request.RequestTimestamp)}</td>
                    <td>
                        ${request.Status === 'Approved' 
                            ? '<span class="badge bg-success">Approved</span>' 
                            : '<span class="badge bg-danger">Rejected</span>'}
                    </td>
                    <td>${request.ProcessedTimestamp ? formatDate(request.ProcessedTimestamp) : 'N/A'}</td>
                </tr>
            `).join('');
        }
        
        // Helper function to get current role
        function getCurrentRole(request) {
            return request.CurrentRole || 'Participant';
        }
        
        // Show request details
        function showRequestDetails(requestId) {
            const request = currentRequests.find(req => req.RequestID === requestId);
            if (!request) return;
            
            selectedRequestId = requestId;
            
            // Update modal content
            document.getElementById('modalUserName').textContent = request.UserName;
            document.getElementById('modalEmail').textContent = request.Email;
            document.getElementById('modalCurrentRole').textContent = getCurrentRole(request);
            document.getElementById('modalRequestedRole').textContent = request.RequestedRole;
            document.getElementById('modalRequestDate').textContent = formatDate(request.RequestTimestamp);
            document.getElementById('modalDetails').textContent = request.Details || 'No additional details provided';
            
            // Show or hide action buttons based on status
            const actionsDiv = document.getElementById('modalActions');
            if (request.Status === 'Pending') {
                actionsDiv.style.display = 'block';
                
                // Set up event listeners for buttons
                document.getElementById('approveBtn').onclick = () => approveRequest(requestId);
                document.getElementById('rejectBtn').onclick = () => rejectRequest(requestId);
            } else {
                actionsDiv.style.display = 'none';
            }
            
            // Show modal
            new bootstrap.Modal(document.getElementById('requestDetailsModal')).show();
        }
        
        // Approve role request
        async function approveRequest(requestId) {
            if (!confirm('Are you sure you want to approve this role request?')) return;
            
            try {
                const response = await fetch(`/api/admin/role-requests/${requestId}/approve`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to approve request');
                }
                
                alert('Role request approved successfully');
                
                // Close modal if open
                const modalElement = document.getElementById('requestDetailsModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) modal.hide();
                
                // Reload requests
                loadRoleRequests();
                
            } catch (error) {
                console.error('Error approving request:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // Reject role request
        async function rejectRequest(requestId) {
            if (!confirm('Are you sure you want to reject this role request?')) return;
            
            try {
                const response = await fetch(`/api/admin/role-requests/${requestId}/reject`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to reject request');
                }
                
                alert('Role request rejected successfully');
                
                // Close modal if open
                const modalElement = document.getElementById('requestDetailsModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) modal.hide();
                
                // Reload requests
                loadRoleRequests();
                
            } catch (error) {
                console.error('Error rejecting request:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString();
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', loadRoleRequests);
    </script>
</body>
</html> 